<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro AI - Suraj Bhise Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <style>
        :root { --primary: #1E3A8A; --success: #10B981; --danger: #EF4444; --warning: #F59E0B; --bg: #F3F4F6; --ai-purple: #6366F1; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #1E293B; height: 100vh; overflow: hidden; }

        .header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #E5E7EB; position: fixed; top: 0; width: 100%; z-index: 1000; }
        .scroller { position: fixed; top: 70px; bottom: 85px; width: 100%; overflow-y: auto; padding: 15px; }
        .scroller::-webkit-scrollbar { display: none; }

        /* Dashboard Cards */
        .card-main { background: linear-gradient(135deg, #0F172A 0%, #1E3A8A 100%); color: white; border-radius: 28px; padding: 22px; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .health-bar-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .health-bar-fill { height: 100%; transition: 1s ease; border-radius: 10px; }
        .grid-emi { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 10px; }
        .emi-box { font-size: 11px; opacity: 0.9; }

        /* Full Screen QR Overlay */
        #qrOverlay { display: none; position: fixed; inset: 0; background: white; z-index: 5000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #fullQrCode { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin: 30px 0; }
        .back-btn { position: absolute; top: 30px; left: 20px; display: flex; align-items: center; color: var(--primary); font-weight: 900; cursor: pointer; }

        /* Nav & List */
        .nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #E5E7EB; }
        .fab { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 30px; transform: translateY(-20px); border: 5px solid var(--bg); }
        .tx-item { background: white; padding: 15px; border-radius: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F1F5F9; }
        .del-icon { color: #CBD5E1; font-size: 20px; cursor: pointer; padding: 5px; }

        /* Sheets & Forms */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet { background: white; width: 100%; padding: 25px; border-radius: 30px 30px 0 0; max-height: 85vh; overflow-y: auto; }
        input, select { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; background: #F3F4F6; border: none; font-size: 16px; outline: none; }
        .btn-action { width: 100%; padding: 18px; border: none; border-radius: 15px; background: var(--primary); color: white; font-weight: bold; font-size: 16px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: #F8FAFC; padding: 15px; border-radius: 15px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:35px; height:35px; border-radius:8px; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;">SB</div>
            <div><b style="font-size:14px;">Suraj AI Business Pro</b></div>
        </div>
        <div style="display:flex; gap:6px;">
            <button class="btn-top" onclick="window.downloadPDF()" style="border:1px solid #ddd; background:#fff; padding:5px 10px; border-radius:8px; font-size:12px;">Report</button>
            <button class="btn-top" onclick="window.saveCurrentLocation()" style="border:1px solid #ddd; background:#fff; padding:5px 10px; border-radius:8px;"><span class="material-symbols-rounded" style="font-size:18px; color:var(--success);">location_on</span></button>
        </div>
    </div>

    <div class="scroller">
        <div class="card-main">
            <small style="opacity:0.8; font-weight:bold;">DAILY NET PROFIT</small>
            <h1 id="net-display" style="font-size:45px; margin:5px 0;">‚Çπ0</h1>
            <div class="health-bar-bg"><div id="health-fill" class="health-bar-fill" style="width:5%; background:var(--danger);"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:12px;">
                <span id="target-info">Target: ‚Çπ0</span>
                <span id="health-status">Checking...</span>
            </div>
            <div id="emi-summary" class="grid-emi"></div>
        </div>

        <div id="aiCoach" class="tx-item" style="border-left: 6px solid var(--ai-purple); display:flex; gap:15px; align-items:center;">
            <span class="material-symbols-rounded" style="color:var(--ai-purple); font-size:35px;">psychology</span>
            <div style="flex:1;">
                <b style="font-size:14px;">Business AI Mind</b><br>
                <small id="coach-msg" style="color:gray;">Calculating your goals...</small>
                <div id="ai-urgent-amt" style="font-size:18px; font-weight:900; margin-top:3px;"></div>
            </div>
        </div>

        <div style="background:white; border-radius:24px; padding:12px; margin:15px 0;"><canvas id="profitChart" height="140"></canvas></div>
        <div id="tx-history-list"></div>
    </div>

    <div id="qrOverlay">
        <div class="back-btn" onclick="window.closeQr()"><span class="material-symbols-rounded">arrow_back_ios</span> WAPAS</div>
        <h2 style="margin-top:50px;">Scan to Pay</h2>
        <p style="color:gray;">Customer ‡§ï‡•ã ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•ã ‡§ï‡§π‡•á‡§Ç</p>
        <div id="fullQrCode"></div>
        <button class="btn-action" style="max-width:300px;" onclick="window.saveData()">DONE & SAVE HISTORY</button>
    </div>

    <div class="nav">
        <div onclick="window.openSettings()"><span class="material-symbols-rounded" style="font-size:30px; color:gray;">settings</span></div>
        <div class="fab" onclick="window.openEntry()">+</div>
        <div onclick="window.openAnalysis()"><span class="material-symbols-rounded" style="font-size:30px; color:var(--ai-purple);">insights</span></div>
    </div>

    <div id="entrySheet" class="overlay">
        <div class="sheet">
            <h3 id="entryTitle">New Entry</h3>
            <select id="typeIn" onchange="window.updateCats()">
                <option value="earning">üí∞ Sawari Income (Scanner)</option>
                <option value="expense">üí∏ Kharcha / Expense</option>
            </select>
            <input type="number" id="amtIn" placeholder="Enter Amount ‚Çπ" inputmode="decimal">
            <select id="catIn" onchange="window.checkOtherCat()"></select>
            <input type="text" id="manualCat" placeholder="Kharcha kis liye? (Example: Chai, Tyre)" style="display:none;">
            <button class="btn-action" id="actionBtn" onclick="window.handleAction()">SHOW SCANNER</button>
            <p onclick="window.closeSheets()" style="text-align:center; margin-top:20px; color:gray; cursor:pointer;">Cancel</p>
        </div>
    </div>

    <div id="settingsSheet" class="overlay">
        <div class="sheet">
            <h3>Settings & Loans</h3>
            <label>Your UPI ID (Scanner ‡§ï‡•á ‡§≤‡§ø‡§è)</label>
            <input type="text" id="upiIdIn" placeholder="example@okaxis">
            <label>Daily Target (‚Çπ)</label>
            <input type="number" id="dailyGoalIn">
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <b>Monthly EMI List</b>
                <button onclick="window.addNewEmi()" style="border:none; color:var(--ai-purple); background:none; font-weight:bold;">+ ADD NEW</button>
            </div>
            <div id="emi-inputs"></div>
            <button class="btn-action" style="background:var(--success); margin-top:15px;" onclick="window.saveSettings()">SAVE ALL SETTINGS</button>
        </div>
    </div>

    <div id="analysisSheet" class="overlay">
        <div class="sheet">
            <h3>Accurate Business Report</h3>
            <div class="stat-grid" id="analysisContent"></div>
            <div style="margin-top:15px; padding:15px; background:#EEF2FF; border-radius:15px;">
                <b style="color:var(--ai-purple);">AI Advice:</b>
                <p id="ai-advice" style="font-size:13px; color:#444; margin-top:5px;"></p>
            </div>
            <button class="btn-action" style="background:gray; margin-top:15px;" onclick="window.closeSheets()">CLOSE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCq6ZTCMeAGhqKH7cZ3d8gn1JSjn7MFkHg", authDomain: "finance-pro-a58ef.firebaseapp.com", projectId: "finance-pro-a58ef", storageBucket: "finance-pro-a58ef.firebasestorage.app", messagingSenderId: "441176545235", appId: "1:441176545235:web:5aa38eaf789b6e5ce1c126" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let transactions = [];
        let chart = null;

        onSnapshot(query(collection(db, "transactions"), orderBy("timestamp", "desc")), (snap) => {
            transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        window.openEntry = () => { document.getElementById('entrySheet').style.display = 'flex'; window.updateCats(); };
        window.closeSheets = () => document.querySelectorAll('.overlay').forEach(s => s.style.display = 'none');
        
        window.updateCats = () => {
            const t = document.getElementById('typeIn').value;
            const btn = document.getElementById('actionBtn');
            const catIn = document.getElementById('catIn');
            document.getElementById('manualCat').style.display = 'none';
            
            if(t === 'earning') {
                btn.innerText = 'SHOW SCANNER';
                catIn.innerHTML = `<option value="üõ∫ Sawari">Sawari</option><option value="üí∞ Tip">Tip</option>`;
            } else {
                btn.innerText = 'SAVE EXPENSE';
                catIn.innerHTML = `<option value="‚õΩ Fuel">Fuel</option><option value="üç≤ Food">Food</option><option value="üõ†Ô∏è Repair">Repair</option><option value="Other">Other (Manual)</option>`;
            }
        };

        window.checkOtherCat = () => {
            const val = document.getElementById('catIn').value;
            document.getElementById('manualCat').style.display = (val === 'Other') ? 'block' : 'none';
        };

        window.handleAction = () => {
            const t = document.getElementById('typeIn').value;
            const amt = document.getElementById('amtIn').value;
            if(!amt) return;
            if(t === 'earning') {
                const upi = localStorage.getItem('userUpi');
                if(!upi) return alert("Settings ‡§Æ‡•á‡§Ç UPI ID ‡§°‡§æ‡§≤‡•á‡§Ç!");
                document.getElementById('qrOverlay').style.display = 'flex';
                const qrDiv = document.getElementById('fullQrCode');
                qrDiv.innerHTML = "";
                new QRCode(qrDiv, { text: `upi://pay?pa=${upi}&pn=Suraj&am=${amt}&cu=INR`, width: 240, height: 240 });
            } else { window.saveData(); }
        };

        window.saveData = async () => {
            const a = parseFloat(document.getElementById('amtIn').value);
            let category = document.getElementById('catIn').value;
            if(category === 'Other') category = "üìÅ " + document.getElementById('manualCat').value;
            
            await addDoc(collection(db, "transactions"), { amount: a, type: document.getElementById('typeIn').value, category: category, timestamp: new Date().toISOString() });
            window.closeQr(); window.closeSheets();
        };

        window.deleteTx = async (id) => { if(confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) await deleteDoc(doc(db, "transactions", id)); };
        window.closeQr = () => document.getElementById('qrOverlay').style.display = 'none';

        window.openAnalysis = () => {
            const inc = transactions.filter(t => t.type === 'earning').reduce((s, e) => s + e.amount, 0);
            const exp = transactions.filter(t => t.type === 'expense').reduce((s, e) => s + e.amount, 0);
            const fuel = transactions.filter(t => t.category === '‚õΩ Fuel').reduce((s, e) => s + e.amount, 0);
            document.getElementById('analysisContent').innerHTML = `
                <div class="stat-box"><small>‡§ï‡•Å‡§≤ ‡§ï‡§Æ‡§æ‡§à</small><br><b>‚Çπ${inc}</b></div>
                <div class="stat-box" style="border-color:red;"><small>‡§ï‡•Å‡§≤ ‡§ñ‡§∞‡•ç‡§ö‡§æ</small><br><b>‚Çπ${exp}</b></div>
                <div class="stat-box" style="border-color:orange;"><small>‡§à‡§Ç‡§ß‡§® ‡§ñ‡§∞‡•ç‡§ö</small><br><b>‚Çπ${fuel}</b></div>
                <div class="stat-box" style="border-color:green;"><small>‡§®‡•á‡§ü ‡§¨‡§ö‡§§</small><br><b>‚Çπ${inc - exp}</b></div>
            `;
            document.getElementById('ai-advice').innerText = fuel > (inc * 0.3) ? "‡§§‡•á‡§≤ ‡§ï‡§æ ‡§ñ‡§∞‡•ç‡§ö‡§æ ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§π‡•à, ‡§∞‡•Ç‡§ü ‡§¨‡§¶‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏‡§ø‡§Ç‡§ó ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç!" : "‡§Ü‡§™‡§ï‡§æ ‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§∏‡§π‡•Ä ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à!";
            document.getElementById('analysisSheet').style.display = 'flex';
        };

        window.openSettings = () => {
            document.getElementById('settingsSheet').style.display = 'flex';
            document.getElementById('upiIdIn').value = localStorage.getItem('userUpi') || '';
            document.getElementById('dailyGoalIn').value = localStorage.getItem('dailyGoal') || '';
            const cont = document.getElementById('emi-inputs'); cont.innerHTML = '';
            JSON.parse(localStorage.getItem('emis') || '[]').forEach(e => window.addNewEmi(e.name, e.amount));
        };

        window.addNewEmi = (n='', a='') => {
            const div = document.createElement('div'); div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
            div.innerHTML = `<input type="text" placeholder="Loan Name" value="${n}" style="flex:2; margin:0;"><input type="number" placeholder="‚Çπ" value="${a}" style="flex:1; margin:0;"><button onclick="this.parentElement.remove()" style="border:none; color:red; background:none; font-weight:bold; font-size:20px;">√ó</button>`;
            document.getElementById('emi-inputs').appendChild(div);
        };

        window.saveSettings = () => {
            localStorage.setItem('userUpi', document.getElementById('upiIdIn').value);
            localStorage.setItem('dailyGoal', document.getElementById('dailyGoalIn').value);
            const emis = []; document.getElementById('emi-inputs').querySelectorAll('div').forEach(r => {
                const inp = r.querySelectorAll('input'); if(inp[0].value) emis.push({ name: inp[0].value, amount: parseFloat(inp[1].value) || 0 });
            });
            localStorage.setItem('emis', JSON.stringify(emis)); window.closeSheets(); render();
        };

        function render() {
            const today = new Date().toDateString();
            const goal = parseFloat(localStorage.getItem('dailyGoal')) || 0;
            const emis = JSON.parse(localStorage.getItem('emis') || '[]');
            let tInc = 0, tExp = 0, dailyEmi = 0;
            
            const emiSum = document.getElementById('emi-summary'); emiSum.innerHTML = '';
            emis.forEach(e => { dailyEmi += (e.amount/30); emiSum.innerHTML += `<div class="emi-box">${e.name} <b>‚Çπ${(e.amount/30).toFixed(0)}</b></div>`; });

            const list = document.getElementById('tx-history-list'); list.innerHTML = '';
            transactions.forEach(t => {
                const dt = new Date(t.timestamp);
                if(dt.toDateString() === today) {
                    if(t.type === 'earning') tInc += t.amount; else tExp += t.amount;
                    list.innerHTML += `<div class="tx-item">
                        <div><b>${t.category}</b><br><small>${dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</small></div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <b style="color:${t.type==='earning'?'var(--success)':'var(--danger)'}">‚Çπ${t.amount}</b>
                            <span class="material-symbols-rounded del-icon" onclick="deleteTx('${t.id}')">delete</span>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('net-display').innerText = "‚Çπ" + (tInc - tExp);
            document.getElementById('target-info').innerText = "Target: ‚Çπ" + goal;
            const fill = document.getElementById('health-fill');
            const prog = (tInc / goal) * 100;
            fill.style.width = Math.min(prog, 100) + "%";
            
            if(tInc < dailyEmi) { 
                fill.style.backgroundColor = 'var(--danger)'; 
                document.getElementById('coach-msg').innerText = "EMI ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•á‡§π‡§®‡§§ ‡§ï‡§∞‡•á‡§Ç!";
                document.getElementById('ai-urgent-amt').innerHTML = `<span style="color:var(--danger)">‚Çπ${(dailyEmi - tInc).toFixed(0)} For EMI</span>`; 
            } else { 
                fill.style.backgroundColor = prog >= 100 ? 'var(--success)' : 'var(--warning)'; 
                document.getElementById('coach-msg').innerText = prog >= 100 ? "‡§Ü‡§ú ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§∞‡§π‡§æ!" : "EMI ‡§∏‡•á‡§´ ‡§π‡•à, ‡§Ö‡§¨ ‡§™‡•ç‡§∞‡•â‡§´‡§ø‡§ü ‡§ï‡§Æ‡§æ‡§è‡§Ç!";
                document.getElementById('ai-urgent-amt').innerHTML = `<span style="color:var(--success)">Goal: ‚Çπ${Math.max(0, goal-tInc)}</span>`; 
            }
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('profitChart');
            const labels = []; const data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i); labels.push(d.toLocaleDateString('hi-IN', {weekday:'short'}));
                let n = 0; transactions.forEach(t => { if(new Date(t.timestamp).toDateString() === d.toDateString()) n += (t.type==='earning'?t.amount:-t.amount); });
                data.push(n);
            }
            if(chart) chart.destroy();
            chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ data, borderColor:'#6366F1', tension:0.4, fill:true, backgroundColor:'rgba(99,102,241,0.1)' }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ display:false }, x:{ grid:{ display:false } } } } });
        }

        window.downloadPDF = () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Suraj Business Report", 10, 10); transactions.forEach((t, i) => doc.text(`${t.timestamp.split('T')[0]} - ${t.category}: Rs.${t.amount}`, 10, 20 + (i*10))); doc.save("Report.pdf"); };
        window.saveCurrentLocation = () => alert("Hotspot saved! Next time AI will notify you here.");
    </script>
</body>
</html>
