<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro AI - Suraj Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <style>
        :root { --primary: #1E3A8A; --success: #10B981; --danger: #EF4444; --warning: #F59E0B; --bg: #F3F4F6; --ai-purple: #6366F1; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #1E293B; height: 100vh; overflow: hidden; }

        .header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #E5E7EB; position: fixed; top: 0; width: 100%; z-index: 1000; }
        .scroller { position: fixed; top: 70px; bottom: 85px; width: 100%; overflow-y: auto; padding: 15px; }
        .scroller::-webkit-scrollbar { display: none; }

        .card-main { background: linear-gradient(135deg, #0F172A 0%, #1E3A8A 100%); color: white; border-radius: 28px; padding: 22px; box-shadow: 0 15px 30px rgba(0,0,0,0.15); margin-bottom: 15px; }
        .health-bar-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .health-bar-fill { height: 100%; transition: 1s ease; border-radius: 10px; }
        .prog-red { background: var(--danger); }
        .prog-yellow { background: var(--warning); }
        .prog-green { background: var(--success); }

        .grid-emi { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .emi-box { font-size: 11px; opacity: 0.9; }
        .emi-box b { display: block; font-size: 14px; color: #DBEAFE; }

        .coach-card { background: white; border-radius: 20px; padding: 18px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 15px; border-left: 6px solid var(--ai-purple); position: relative; }
        .sig-box { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; background: #EEF2FF; color: var(--ai-purple); }

        .btn-top { padding: 6px 12px; border-radius: 8px; border: 1px solid #E5E7EB; background: #F9FAFB; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-top.active { background: var(--primary); color: white; }

        .tx-item { background: white; padding: 16px; border-radius: 18px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #F1F5F9; }
        
        .nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #E5E7EB; }
        .fab { width: 62px; height: 62px; background: var(--primary); color: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; transform: translateY(-22px); border: 6px solid var(--bg); box-shadow: 0 10px 20px rgba(30,58,138,0.3); }

        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; backdrop-filter: blur(5px); }
        .sheet { background: white; width: 100%; padding: 25px; border-radius: 30px 30px 0 0; max-height: 85vh; overflow-y: auto; }
        input, select { width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; background: #F3F4F6; border: none; font-size: 16px; outline: none; }
        .btn-action { width: 100%; padding: 18px; border: none; border-radius: 15px; background: var(--primary); color: white; font-weight: 700; }
        .big-amt { font-size: 26px; font-weight: 900; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:35px; height:35px; border-radius:8px; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;">SB</div>
            <div><b style="font-size:14px;">Suraj AI Business</b></div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn-top active" id="btn-t" onclick="window.setFilter('today', this)">Today</button>
            <button class="btn-top" id="btn-m" onclick="window.setFilter('month', this)">Month</button>
            <button class="btn-top" onclick="window.saveCurrentLocation()"><span class="material-symbols-rounded" style="font-size:18px; color:var(--success);">add_location_alt</span></button>
        </div>
    </div>

    <div class="scroller">
        <div class="card-main">
            <small style="opacity:0.8; font-weight:bold;">DAILY NET PROFIT</small>
            <h1 id="net-display" style="font-size:45px; margin:5px 0;">‚Çπ0</h1>
            <div class="health-bar-bg"><div id="health-fill" class="health-bar-fill"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:600;">
                <span id="target-info">Target: ‚Çπ0</span>
                <span id="health-status">Checking...</span>
            </div>
            <div id="emi-summary" class="grid-emi"></div>
        </div>

        <div class="coach-card">
            <div class="sig-box"><span class="material-symbols-rounded">psychology</span></div>
            <div style="flex:1;">
                <b id="ai-title" style="color:var(--ai-purple);">AI Smart Coach</b><br>
                <small id="coach-msg" style="color:#4B5563; font-size:13px;">Analyzing your business...</small>
                <div id="ai-urgent-amt" class="big-amt"></div>
            </div>
        </div>

        <div style="background:white; border-radius:24px; padding:12px; margin-bottom:15px;">
            <canvas id="profitChart" height="140"></canvas>
        </div>

        <div id="tx-history-list"></div>
    </div>

    <div class="nav">
        <div onclick="window.openSettings()"><span class="material-symbols-rounded" style="font-size:30px; color:gray;">settings</span></div>
        <div class="fab" onclick="window.openEntry()">+</div>
        <div onclick="window.showAnalysis()"><span class="material-symbols-rounded" style="font-size:30px; color:var(--ai-purple);">query_stats</span></div>
    </div>

    <div id="entrySheet" class="overlay">
        <div class="sheet">
            <h3>New Entry</h3>
            <select id="typeIn" onchange="window.updateCats()">
                <option value="earning">üí∞ Sawari Income</option>
                <option value="expense">üí∏ Expense / Kharcha</option>
            </select>
            <input type="number" id="amtIn" placeholder="Amount ‚Çπ" inputmode="decimal">
            <select id="catIn"></select>
            <button class="btn-action" onclick="window.saveData()">CONFIRM SAVE</button>
            <p onclick="window.closeSheets()" style="text-align:center; margin-top:20px; color:gray; cursor:pointer;">Cancel</p>
        </div>
    </div>

    <div id="settingsSheet" class="overlay">
        <div class="sheet">
            <h3>Business Settings</h3>
            <label style="font-size:12px; font-weight:bold; color:var(--primary);">DAILY TARGET (‚Çπ)</label>
            <input type="number" id="dailyGoalIn" placeholder="e.g. 1500">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                <label style="font-size:12px; font-weight:bold; color:var(--danger);">MONTHLY EMI / BILLS</label>
                <button onclick="window.addNewEmi()" style="background:none; border:none; color:var(--ai-purple); font-weight:bold;">+ ADD NEW</button>
            </div>
            <div id="emi-inputs"></div>

            <button class="btn-action" style="background:var(--success); margin-top:20px;" onclick="window.saveSettings()">SAVE ALL SETTINGS</button>
            <p onclick="window.closeSheets()" style="text-align:center; margin-top:20px; color:gray; cursor:pointer;">Close</p>
        </div>
    </div>

    <div id="analysisSheet" class="overlay">
        <div class="sheet" style="border-radius:20px 20px 0 0;">
            <h2 style="margin-bottom:15px;">Business Analysis</h2>
            <div id="analysisContent"></div>
            <button class="btn-action" onclick="window.closeSheets()" style="margin-top:20px;">BACK TO HOME</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCq6ZTCMeAGhqKH7cZ3d8gn1JSjn7MFkHg",
            authDomain: "finance-pro-a58ef.firebaseapp.com",
            projectId: "finance-pro-a58ef",
            storageBucket: "finance-pro-a58ef.firebasestorage.app",
            messagingSenderId: "441176545235",
            appId: "1:441176545235:web:5aa38eaf789b6e5ce1c126"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let transactions = [];
        let filterMode = 'today';
        let chart = null;

        onSnapshot(query(collection(db, "transactions"), orderBy("timestamp", "desc")), (snap) => {
            transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        // --- EMI & Settings Logic ---
        window.openSettings = () => {
            document.getElementById('settingsSheet').style.display = 'flex';
            document.getElementById('dailyGoalIn').value = localStorage.getItem('dailyGoal') || '';
            const container = document.getElementById('emi-inputs'); container.innerHTML = '';
            const emis = JSON.parse(localStorage.getItem('emis') || '[]');
            emis.forEach(e => window.addNewEmi(e.name, e.amount));
        };

        window.addNewEmi = (n='', a='') => {
            const div = document.createElement('div'); div.style.display = 'flex'; div.style.gap = '8px';
            div.innerHTML = `<input type="text" placeholder="EMI Name" value="${n}" style="flex:2"><input type="number" placeholder="‚Çπ" value="${a}" style="flex:1">`;
            document.getElementById('emi-inputs').appendChild(div);
        };

        window.saveSettings = () => {
            localStorage.setItem('dailyGoal', document.getElementById('dailyGoalIn').value);
            const emis = []; document.getElementById('emi-inputs').querySelectorAll('div').forEach(row => {
                const inp = row.querySelectorAll('input');
                if(inp[0].value) emis.push({ name: inp[0].value, amount: parseFloat(inp[1].value) || 0 });
            });
            localStorage.setItem('emis', JSON.stringify(emis));
            window.closeSheets(); render();
        };

        // --- Core Functions ---
        window.openEntry = () => { document.getElementById('entrySheet').style.display = 'flex'; window.updateCats(); };
        window.closeSheets = () => document.querySelectorAll('.overlay').forEach(s => s.style.display = 'none');
        window.setFilter = (m, b) => { filterMode = m; document.querySelectorAll('.btn-top').forEach(c => c.classList.remove('active')); b.classList.add('active'); render(); };
        
        window.updateCats = () => {
            const t = document.getElementById('typeIn').value;
            document.getElementById('catIn').innerHTML = t === 'earning' ? 
                `<option value="üõ∫ Sawari">üõ∫ Sawari</option><option value="üí∞ Tip">üí∞ Tip</option>` : 
                `<option value="‚õΩ Fuel">‚õΩ Fuel</option><option value="üõ†Ô∏è Maintenance">üõ†Ô∏è Maintenance</option><option value="üç≤ Food">üç≤ Food</option><option value="üîß Annual Repair">üîß Annual Repair</option><option value="üè† Ghar">üè† Ghar Kharch</option>`;
        };

        window.saveData = async () => {
            const a = parseFloat(document.getElementById('amtIn').value);
            if(!a) return;
            await addDoc(collection(db, "transactions"), { amount: a, type: document.getElementById('typeIn').value, category: document.getElementById('catIn').value, timestamp: new Date().toISOString() });
            document.getElementById('amtIn').value = ''; window.closeSheets();
        };

        window.deleteTx = async (id) => { if(confirm("Delete this?")) await deleteDoc(doc(db, "transactions", id)); };

        // --- New: Analysis Screen Logic ---
        window.showAnalysis = () => {
            const totalInc = transactions.filter(t => t.type === 'earning').reduce((a, b) => a + b.amount, 0);
            const totalExp = transactions.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const fuelExp = transactions.filter(t => t.category === '‚õΩ Fuel').reduce((a, b) => a + b.amount, 0);

            document.getElementById('analysisContent').innerHTML = `
                <div style="background:#EEF2FF; padding:15px; border-radius:15px; margin-bottom:10px;">
                    <small>Kul Kamai (Lifetime)</small><h2 style="color:var(--success)">‚Çπ${totalInc}</h2>
                </div>
                <div style="background:#FFF1F2; padding:15px; border-radius:15px; margin-bottom:10px;">
                    <small>Kul Kharcha</small><h2 style="color:var(--danger)">‚Çπ${totalExp}</h2>
                </div>
                <div style="background:#F0FDF4; padding:15px; border-radius:15px;">
                    <small>Fuel Par Kharch</small><h2>‚Çπ${fuelExp}</h2>
                    <p style="font-size:12px; margin-top:5px;">AI Tips: Fuel par control karein, profit badhega!</p>
                </div>
            `;
            document.getElementById('analysisSheet').style.display = 'flex';
        };

        function render() {
            const list = document.getElementById('tx-history-list'); list.innerHTML = '';
            const todayStr = new Date().toDateString();
            const goal = parseFloat(localStorage.getItem('dailyGoal')) || 0;
            const emis = JSON.parse(localStorage.getItem('emis') || '[]');
            
            let todayInc = 0, todayExp = 0, totalDailyEmi = 0;

            const emiSummary = document.getElementById('emi-summary'); emiSummary.innerHTML = '';
            emis.forEach(e => {
                const dailyEmiShare = e.amount / 30;
                totalDailyEmi += dailyEmiShare;
                emiSummary.innerHTML += `<div class="emi-box">${e.name} (Daily)<b>‚Çπ${dailyEmiShare.toFixed(0)}</b></div>`;
            });

            transactions.forEach(t => {
                const dt = new Date(t.timestamp);
                const isT = dt.toDateString() === todayStr;
                if(isT) { if(t.type === 'earning') todayInc += t.amount; else todayExp += t.amount; }

                if(filterMode === 'all' || (filterMode === 'today' && isT) || (filterMode === 'month' && dt.getMonth() === new Date().getMonth())) {
                    list.innerHTML += `<div class="tx-item">
                        <div><b>${t.category}</b><br><small>${dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <b style="color:${t.type==='earning'?'var(--success)':'var(--danger)'}">‚Çπ${t.amount}</b>
                            <span class="material-symbols-rounded" onclick="deleteTx('${t.id}')" style="color:#CBD5E1; cursor:pointer;">delete</span>
                        </div>
                    </div>`;
                }
            });

            const dailyNet = todayInc - todayExp;
            document.getElementById('net-display').innerText = "‚Çπ" + (filterMode === 'today' ? dailyNet : (todayInc - todayExp)).toLocaleString('en-IN');
            document.getElementById('target-info').innerText = "Target: ‚Çπ" + goal;
            
            const bar = document.getElementById('health-fill');
            const aiMsg = document.getElementById('coach-msg');
            const aiAmt = document.getElementById('ai-urgent-amt');
            const statusText = document.getElementById('health-status');

            let progress = (todayInc / goal) * 100;
            if(progress > 100) progress = 100;

            if(todayInc === 0) {
                bar.className = 'health-bar-fill prog-red'; bar.style.width = '5%';
                aiMsg.innerText = "‡§∏‡•Ç‡§∞‡§ú, ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§™‡§π‡§≤‡•Ä ‡§∏‡§µ‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Ç!";
                statusText.innerText = "Wait";
            } else if (todayInc < totalDailyEmi) {
                bar.className = 'health-bar-fill prog-red'; bar.style.width = progress + '%';
                aiMsg.innerText = "‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç: ‡§Ö‡§≠‡•Ä EMI ‡§ï‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§≠‡•Ä ‡§™‡•Ç‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à‡•§";
                aiAmt.innerHTML = `<span style="color:var(--danger)">‚Çπ${(totalDailyEmi - todayInc).toFixed(0)} for EMI</span>`;
                statusText.innerText = "Low";
            } else if (todayInc < goal) {
                bar.className = 'health-bar-fill prog-yellow'; bar.style.width = progress + '%';
                aiMsg.innerText = "EMI ‡§ï‡§µ‡§∞ ‡§π‡•ã ‡§ó‡§à! ‡§Ö‡§¨ ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§ï‡•Ä ‡§¨‡§æ‡§∞‡•Ä ‡§π‡•à‡•§";
                aiAmt.innerHTML = `<span style="color:var(--warning)">‚Çπ${(goal - todayInc).toFixed(0)} to Goal</span>`;
                statusText.innerText = "Good";
            } else {
                bar.className = 'health-bar-fill prog-green'; bar.style.width = '100%';
                aiMsg.innerText = "Target ‡§™‡•Ç‡§∞‡§æ! ‡§Ü‡§ú ‡§Ü‡§™‡§®‡•á ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§ï‡§æ‡§Æ ‡§ï‡§ø‡§Ø‡§æ‡•§";
                aiAmt.innerHTML = `<span style="color:var(--success)">Profit: ‚Çπ${dailyNet}</span>`;
                statusText.innerText = "Hit!";
            }
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('profitChart');
            const days = []; const data = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                days.push(d.toLocaleDateString('hi-IN', {weekday:'short'}));
                let n = 0; transactions.forEach(t => { if(new Date(t.timestamp).toDateString() === d.toDateString()) n += (t.type==='earning'?t.amount:-t.amount); });
                data.push(n);
            }
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line', data: { labels: days, datasets: [{ data, borderColor: '#6366F1', tension: 0.4, fill: true, backgroundColor: 'rgba(99,102,241,0.1)', borderWidth: 3, pointRadius: 4 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }
        
        window.saveCurrentLocation = () => alert("AI: Location saved for route analysis!");
    </script>
</body>
</html>
